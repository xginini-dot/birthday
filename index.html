<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>생월별 생일자 리스트업</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SheetJS (엑셀 파서) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --accent: #22d3ee;
      --text: #e5e7eb;
      --muted: #9ca3af;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,
        'Apple SD Gothic Neo','Noto Sans KR',sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 52%);
      color: var(--text);
    }
    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }
    header {
      margin-bottom: 20px;
    }
    header h1 {
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    header h1 span.badge {
      font-size: 11px;
      font-weight: 600;
      color: var(--accent);
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(34,211,238,0.3);
      background: rgba(15,23,42,0.8);
    }
    header p {
      margin: 4px 0 0;
      font-size: 13px;
      color: var(--muted);
    }

    .card {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.08), transparent 45%),
                  radial-gradient(circle at bottom right, rgba(56,189,248,0.05), transparent 55%),
                  var(--card);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.18);
      padding: 16px;
      box-shadow:
        0 18px 45px rgba(15,23,42,0.7),
        0 0 0 1px rgba(15,23,42,0.9);
      backdrop-filter: blur(18px);
      margin-bottom: 16px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .card-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-title::before {
      content: "";
      width: 18px;
      height: 18px;
      border-radius: 6px;
      background: radial-gradient(circle at 30% 15%, #e0f2fe 0, transparent 55%),
                  linear-gradient(135deg, #0ea5e9, #22d3ee);
      box-shadow: 0 0 18px rgba(56,189,248,0.55);
    }
    .card-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .controls .file-box {
      flex: 1 1 240px;
      border-radius: 14px;
      border: 1px dashed rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.7);
      padding: 10px;
      font-size: 12px;
    }
    .controls label {
      font-size: 11px;
      color: var(--muted);
      display: block;
      margin-bottom: 4px;
    }
    input[type="file"] {
      width: 100%;
      font-size: 11px;
      color: var(--muted);
    }
    input[type="date"], select {
      background: rgba(15,23,42,0.9);
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      padding: 4px 9px;
      font-size: 11px;
      color: #e5e7eb;
    }

    .btn-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    button {
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 12px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }
    button.primary {
      background: linear-gradient(135deg, #06b6d4, #22d3ee);
      color: #0f172a;
      box-shadow: 0 12px 30px rgba(8,47,73,0.7);
    }
    button.secondary {
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      border: 1px solid rgba(148,163,184,0.5);
    }
    button:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .status-text {
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
      white-space: pre-line;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 12px;
      border-radius: 12px;
      overflow: hidden;
    }
    thead { background: rgba(15,23,42,0.98); }
    thead th {
      font-weight: 500;
      color: var(--muted);
      padding: 6px 8px;
      border-bottom: 1px solid rgba(55,65,81,0.9);
      text-align: left;
      white-space: nowrap;
    }
    tbody tr:nth-child(odd) { background: rgba(15,23,42,0.85); }
    tbody tr:nth-child(even) { background: rgba(17,24,39,0.95); }
    tbody td {
      padding: 5px 8px;
      border-bottom: 1px solid rgba(31,41,55,0.8);
      white-space: nowrap;
    }
    tbody tr:last-child td { border-bottom: none; }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>
      생월별 생일자 리스트업
      <span class="badge">엑셀 업로드 · n월 생일자</span>
    </h1>
    <p>월별신환 엑셀을 업로드하면, 주민번호 기준 기준일 현재 만나이와 생년월일을 계산하여<br>
       선택한 <strong>n월 생일자</strong>의 차트번호 / 성명 / 전화번호 / 만나이 / 생년월일을 리스트업합니다.</p>
  </header>

  <!-- 업로드 + 기준일 카드 -->
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">엑셀 업로드 & 기준일 설정</div>
        <div class="card-subtitle">
          첫 번째 시트에 <code>차트번호 / 성명(또는 이름/환자명) / 주민번호 / 휴대폰(또는 전화번호)</code> 열이 포함된 엑셀을 선택하세요.
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="file-box">
        <label for="file-main">신환 엑셀 파일</label>
        <input type="file" id="file-main" accept=".xlsx,.xls" />
      </div>
      <div>
        <label for="ref-date">기준일 (만나이 계산 기준)</label>
        <input type="date" id="ref-date" />
      </div>
      <div>
        <label for="birth-month">생월 선택</label>
        <select id="birth-month">
          <option value="01">1월</option>
          <option value="02">2월</option>
          <option value="03">3월</option>
          <option value="04">4월</option>
          <option value="05">5월</option>
          <option value="06">6월</option>
          <option value="07">7월</option>
          <option value="08">8월</option>
          <option value="09">9월</option>
          <option value="10">10월</option>
          <option value="11">11월</option>
          <option value="12">12월</option>
        </select>
      </div>
    </div>

    <div class="btn-row">
      <button class="secondary" id="btn-clear" type="button">초기화</button>
      <button class="primary" id="btn-run" type="button">생일자 조회</button>
    </div>

    <div class="status-text" id="status-text">
      파일을 선택한 뒤 기준일과 생월을 설정하고 &lt;생일자 조회&gt; 버튼을 눌러주세요.
    </div>
  </section>

  <!-- 생월별 생일자 카드 -->
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">생월별 생일자 리스트</div>
        <div class="card-subtitle">
          주민번호에서 생년월일을 추출하여, 선택한 <strong>n월 생일자</strong>의 차트번호 / 성명 / 전화번호 / 만나이 / 생년월일을 표시합니다.
        </div>
      </div>
    </div>

    <table id="birth-table">
      <thead>
        <tr>
          <th>차트번호</th>
          <th>성명</th>
          <th>전화번호</th>
          <th>만나이</th>
          <th>생년월일</th>
        </tr>
      </thead>
      <tbody>
        <!-- JS -->
      </tbody>
    </table>
  </section>
</div>

<script>
  // 기준일: 기본값을 오늘 날짜로 세팅
  const refDateInput = document.getElementById("ref-date");
  (function initRefDate() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    refDateInput.value = `${yyyy}-${mm}-${dd}`;
  })();

  const fileInput = document.getElementById("file-main");
  const runBtn = document.getElementById("btn-run");
  const clearBtn = document.getElementById("btn-clear");
  const birthMonthSelect = document.getElementById("birth-month");
  const statusTextEl = document.getElementById("status-text");
  const tbodyBirth = document.querySelector("#birth-table tbody");

  let baseRows = [];
  let processedRecords = []; // chart/name/phone/age/birthDate/birthMonth

  function updateStatus(msg, isError = false) {
    statusTextEl.textContent = msg;
    statusTextEl.style.color = isError ? "#fca5a5" : "var(--muted)";
  }

  async function readExcelFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const firstSheet = workbook.SheetNames[0];
          const sheet = workbook.Sheets[firstSheet];
          const json = XLSX.utils.sheet_to_json(sheet, { defval: null });
          resolve(json);
        } catch (err) {
          reject(err);
        }
      };
      reader.onerror = err => reject(err);
      reader.readAsArrayBuffer(file);
    });
  }

  function formatDate(date) {
    if (!date) return "";
    const yyyy = date.getFullYear();
    const mm = String(date.getMonth() + 1).padStart(2, "0");
    const dd = String(date.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  // 주민번호 → (생년월일, 만나이, 생월)
  function parseBirthAndAge(rrn, refDate) {
    if (!rrn) return { age: null, birthDate: null, birthMonth: null };
    const s = String(rrn).replace(/[^0-9]/g, "");
    if (s.length < 7) return { age: null, birthDate: null, birthMonth: null };

    const birth6 = s.slice(0, 6);
    const code = s[6];

    let century;
    if (["1","2","5","6"].includes(code)) century = 1900;
    else if (["3","4","7","8"].includes(code)) century = 2000;
    else return { age: null, birthDate: null, birthMonth: null };

    const yy = parseInt(birth6.slice(0, 2), 10);
    const mm = parseInt(birth6.slice(2, 4), 10);
    const dd = parseInt(birth6.slice(4, 6), 10);
    if (!yy || !mm || !dd) return { age: null, birthDate: null, birthMonth: null };

    const year = century + yy;
    const birthDate = new Date(year, mm - 1, dd);
    if (isNaN(birthDate.getTime())) return { age: null, birthDate: null, birthMonth: null };

    let age = refDate.getFullYear() - year;
    const refMonth = refDate.getMonth();
    const refDay = refDate.getDate();
    if (refMonth < (mm - 1) || (refMonth === (mm - 1) && refDay < dd)) age--;

    if (age < 0 || age > 120 || isNaN(age)) age = null;

    return { age, birthDate, birthMonth: mm };
  }

  // 헤더 자동 인식: "차트", "성명/이름", "주민", "휴대폰/전화" 글자 포함 여부로 찾기
  function detectColumnKeys(rows) {
    const first = rows[0] || {};
    const keys = Object.keys(first);
    const trim = (s) => s.replace(/\s/g, "");

    let colChart = null;
    let colName  = null;
    let colPhone = null;
    let colRRN   = null;

    keys.forEach(k => {
      const nk = trim(String(k));
      if (!colChart && /차트|환자번호|차트번호/i.test(nk)) colChart = k;
      if (!colName  && /성명|이름|환자명/i.test(nk))       colName  = k;
      if (!colPhone && /휴대|전화/i.test(nk))              colPhone = k;
      if (!colRRN   && /주민/i.test(nk))                   colRRN   = k;
    });

    return { colChart, colName, colPhone, colRRN };
  }

  function renderBirthdayList(monthStr) {
    tbodyBirth.innerHTML = "";
    if (!processedRecords.length) {
      updateStatus("먼저 엑셀을 분석한 뒤 생일자를 조회할 수 있습니다.", true);
      return;
    }

    const targetMonth = parseInt(monthStr, 10); // 1~12
    const filtered = processedRecords.filter(r => r.birthMonth === targetMonth);

    // 차트번호 기준 정렬
    filtered.sort((a, b) => {
      const na = Number(String(a.chartNum).replace(/[^0-9]/g,"")) || 0;
      const nb = Number(String(b.chartNum).replace(/[^0-9]/g,"")) || 0;
      return na - nb;
    });

    filtered.forEach(r => {
      const tr = document.createElement("tr");

      const tdChart = document.createElement("td");
      tdChart.textContent = r.chartNum ?? "";
      tr.appendChild(tdChart);

      const tdName = document.createElement("td");
      tdName.textContent = r.name ?? "";
      tr.appendChild(tdName);

      const tdPhone = document.createElement("td");
      tdPhone.textContent = r.phone ?? "";
      tr.appendChild(tdPhone);

      const tdAge = document.createElement("td");
      tdAge.textContent = r.age != null ? r.age + "세" : "";
      tr.appendChild(tdAge);

      const tdBirth = document.createElement("td");
      tdBirth.textContent = r.birthDate ? formatDate(r.birthDate) : "";
      tr.appendChild(tdBirth);

      tbodyBirth.appendChild(tr);
    });

    updateStatus(
      `분석 완료: 전체 ${processedRecords.length}명 중 ` +
      `${targetMonth}월 생일자는 ${filtered.length}명입니다.`
    );
  }

  async function handleRun() {
    try {
      const file = fileInput.files[0];
      if (!file) {
        updateStatus("엑셀 파일을 먼저 선택해 주세요.", true);
        return;
      }
      if (!refDateInput.value) {
        updateStatus("기준일을 입력해 주세요.", true);
        return;
      }

      runBtn.disabled = true;
      updateStatus("엑셀을 읽는 중입니다…");

      const rows = await readExcelFile(file);
      baseRows = rows;
      processedRecords = [];
      tbodyBirth.innerHTML = "";

      if (!rows.length) {
        updateStatus("시트에 데이터가 없습니다.", true);
        runBtn.disabled = false;
        return;
      }

      const refDateParts = refDateInput.value.split("-");
      const refDate = new Date(
        Number(refDateParts[0]),
        Number(refDateParts[1]) - 1,
        Number(refDateParts[2])
      );

      const { colChart, colName, colPhone, colRRN } = detectColumnKeys(rows);

      if (!colChart || !colName || !colRRN) {
        updateStatus(
`헤더를 찾지 못했습니다. (차트/이름/주민 관련 열 이름을 확인해 주세요)
찾은 열 → 차트:${colChart || "-"}, 이름:${colName || "-"}, 주민:${colRRN || "-"}, 전화:${colPhone || "-"}`,
          true
        );
        runBtn.disabled = false;
        return;
      }

      let total = 0, withRRN = 0;

      rows.forEach(row => {
        total++;
        const chartNum = row[colChart];
        const name = row[colName];
        const phone = colPhone ? row[colPhone] : "";
        const rrn = row[colRRN];

        if (!rrn) return;
        withRRN++;

        const { age, birthDate, birthMonth } = parseBirthAndAge(rrn, refDate);
        if (age == null || !birthDate || !birthMonth) return;

        processedRecords.push({
          chartNum,
          name,
          phone: phone || "",
          age,
          birthDate,
          birthMonth
        });
      });

      // 기본 선택된 월로 한 번 바로 조회
      renderBirthdayList(birthMonthSelect.value);
      runBtn.disabled = false;

      updateStatus(
        `엑셀 분석 완료: 전체 ${total}행 / 주민번호 있는 ${withRRN}행 중\n` +
        `유효한 생년월일이 있는 환자 ${processedRecords.length}명의 정보를 저장했습니다.\n` +
        `다른 생월을 보고 싶으면 상단에서 월을 바꾸고 [생일자 조회]를 다시 눌러주세요.`
      );
    } catch (err) {
      console.error(err);
      updateStatus("엑셀 파싱 중 오류가 발생했습니다. 파일 형식/헤더명을 확인해 주세요.", true);
      runBtn.disabled = false;
    }
  }

  function handleClear() {
    fileInput.value = "";
    tbodyBirth.innerHTML = "";
    baseRows = [];
    processedRecords = [];
    updateStatus("초기화 완료. 엑셀을 다시 선택한 뒤 조회해 주세요.");
  }

  runBtn.addEventListener("click", handleRun);
  clearBtn.addEventListener("click", handleClear);
</script>
</body>
</html>
