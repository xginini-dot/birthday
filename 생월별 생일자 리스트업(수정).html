<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë§Œ 18ì„¸ ì´ˆê³¼ nì›” ìƒì¼ì ë¦¬ìŠ¤íŠ¸ì—…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SheetJS (ì—‘ì…€ íŒŒì„œ) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --accent: #22d3ee;
      --text: #e5e7eb;
      --muted: #9ca3af;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,
        'Apple SD Gothic Neo','Noto Sans KR',sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 52%);
      color: var(--text);
    }
    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }
    header {
      margin-bottom: 20px;
    }
    header h1 {
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    header h1 span.badge {
      font-size: 11px;
      font-weight: 600;
      color: var(--accent);
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(34,211,238,0.3);
      background: rgba(15,23,42,0.8);
    }
    header p {
      margin: 4px 0 0;
      font-size: 13px;
      color: var(--muted);
    }

    .card {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.08), transparent 45%),
                  radial-gradient(circle at bottom right, rgba(56,189,248,0.05), transparent 55%),
                  var(--card);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.18);
      padding: 16px;
      box-shadow:
        0 18px 45px rgba(15,23,42,0.7),
        0 0 0 1px rgba(15,23,42,0.9);
      backdrop-filter: blur(18px);
      margin-bottom: 16px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .card-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-title::before {
      content: "";
      width: 18px;
      height: 18px;
      border-radius: 6px;
      background: radial-gradient(circle at 30% 15%, #e0f2fe 0, transparent 55%),
                  linear-gradient(135deg, #0ea5e9, #22d3ee);
      box-shadow: 0 0 18px rgba(56,189,248,0.55);
    }
    .card-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .controls .file-box {
      flex: 1 1 240px;
      border-radius: 14px;
      border: 1px dashed rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.7);
      padding: 10px;
      font-size: 12px;
    }
    .controls label {
      font-size: 11px;
      color: var(--muted);
      display: block;
      margin-bottom: 4px;
    }
    input[type="file"] {
      width: 100%;
      font-size: 11px;
      color: var(--muted);
    }
    input[type="date"], select {
      background: rgba(15,23,42,0.9);
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      padding: 4px 9px;
      font-size: 11px;
      color: #e5e7eb;
    }

    .btn-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    button {
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 12px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }
    button.primary {
      background: linear-gradient(135deg, #06b6d4, #22d3ee);
      color: #0f172a;
      box-shadow: 0 12px 30px rgba(8,47,73,0.7);
    }
    button.secondary {
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      border: 1px solid rgba(148,163,184,0.5);
    }
    button:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .status-text {
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
      white-space: pre-line;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 12px;
      border-radius: 12px;
      overflow: hidden;
    }
    thead { background: rgba(15,23,42,0.98); }
    thead th {
      font-weight: 500;
      color: var(--muted);
      padding: 6px 8px;
      border-bottom: 1px solid rgba(55,65,81,0.9);
      text-align: left;
      white-space: nowrap;
    }
    tbody tr:nth-child(odd) { background: rgba(15,23,42,0.85); }
    tbody tr:nth-child(even) { background: rgba(17,24,39,0.95); }
    tbody td {
      padding: 5px 8px;
      border-bottom: 1px solid rgba(31,41,55,0.8);
      white-space: nowrap;
    }
    tbody tr:last-child td { border-bottom: none; }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>
      ë§Œ 18ì„¸ ì´ˆê³¼ nì›” ìƒì¼ì ë¦¬ìŠ¤íŠ¸ì—…
      <span class="badge">ì—‘ì…€ ì—…ë¡œë“œ Â· ì˜¤ëŠ˜ ê¸°ì¤€ Â· nì›” ìƒì¼ì</span>
    </h1>
    <p>
      ì›”ë³„ì‹ í™˜ ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ë©´, ì£¼ë¯¼ë²ˆí˜¸ ê¸°ì¤€ ê¸°ì¤€ì¼ í˜„ì¬ ë§Œë‚˜ì´ì™€ ìƒë…„ì›”ì¼ì„ ê³„ì‚°í•˜ì—¬<br>
      <strong>ë§Œ 18ì„¸ ì´ˆê³¼(19ì„¸ ì´ìƒ)</strong> ì´ë©´ì„œ ì„ íƒí•œ <strong>nì›” ìƒì¼ì</strong>ì¸ í™˜ìë¥¼
      ì°¨íŠ¸ë²ˆí˜¸ / ì„±ëª… / ì „í™”ë²ˆí˜¸ / ë§Œë‚˜ì´ / ìƒë…„ì›”ì¼ë¡œ ë¦¬ìŠ¤íŠ¸ì—…í•©ë‹ˆë‹¤.
    </p>
  </header>

  <!-- ì—…ë¡œë“œ + ê¸°ì¤€ì¼ ì¹´ë“œ -->
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">ì—‘ì…€ ì—…ë¡œë“œ & ê¸°ì¤€ì¼ Â· ìƒì›” ì„¤ì •</div>
        <div class="card-subtitle">
          ì²« ë²ˆì§¸ ì‹œíŠ¸ì— <code>ì°¨íŠ¸ë²ˆí˜¸ / ì„±ëª…(ë˜ëŠ” ì´ë¦„/í™˜ìëª…) / ì£¼ë¯¼ë²ˆí˜¸ / íœ´ëŒ€í°(ë˜ëŠ” ì „í™”ë²ˆí˜¸)</code> ì—´ì´ í¬í•¨ëœ ì—‘ì…€ì„ ì„ íƒí•˜ì„¸ìš”.
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="file-box">
        <label for="file-main">ì‹ í™˜ ì—‘ì…€ íŒŒì¼</label>
        <input type="file" id="file-main" accept=".xlsx,.xls" />
      </div>
      <div>
        <label for="ref-date">ê¸°ì¤€ì¼ (ë§Œë‚˜ì´ ê³„ì‚° ê¸°ì¤€)</label>
        <input type="date" id="ref-date" />
      </div>
      <div>
        <label for="birth-month">ìƒì›” ì„ íƒ</label>
        <select id="birth-month">
          <option value="01">1ì›”</option>
          <option value="02">2ì›”</option>
          <option value="03">3ì›”</option>
          <option value="04">4ì›”</option>
          <option value="05">5ì›”</option>
          <option value="06">6ì›”</option>
          <option value="07">7ì›”</option>
          <option value="08">8ì›”</option>
          <option value="09">9ì›”</option>
          <option value="10">10ì›”</option>
          <option value="11">11ì›”</option>
          <option value="12">12ì›”</option>
        </select>
      </div>
    </div>

    <div class="btn-row">
      <button class="secondary" id="btn-clear" type="button">ì´ˆê¸°í™”</button>
      <button class="primary" id="btn-run" type="button">ë¶„ì„ ë° ë¦¬ìŠ¤íŠ¸ì—…</button>
    </div>

    <div class="status-text" id="status-text">
      íŒŒì¼ì„ ì„ íƒí•œ ë’¤ ê¸°ì¤€ì¼ê³¼ ìƒì›”ì„ ì„¤ì •í•˜ê³  &lt;ë¶„ì„ ë° ë¦¬ìŠ¤íŠ¸ì—…&gt; ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
    </div>
  </section>

  <!-- ìµœì¢… ê²°ê³¼ ì¹´ë“œ: ë§Œ18ì„¸ ì´ˆê³¼ + nì›” ìƒì¼ì -->
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">ì˜¤ëŠ˜ ê¸°ì¤€ ë§Œ 18ì„¸ ì´ˆê³¼ nì›” ìƒì¼ì ë¦¬ìŠ¤íŠ¸</div>
        <div class="card-subtitle">
          ì£¼ë¯¼ë²ˆí˜¸ì—ì„œ ìƒë…„ì›”ì¼ì„ ì¶”ì¶œí•˜ì—¬, <strong>ê¸°ì¤€ì¼ í˜„ì¬ ë§Œë‚˜ì´ê°€ 19ì„¸ ì´ìƒ</strong>ì´ë©´ì„œ
          ì„ íƒí•œ <strong>nì›” ìƒì¼ì</strong>ë§Œ ì•„ë˜ì— í‘œì‹œí•©ë‹ˆë‹¤.
        </div>
      </div>
    </div>

    <table id="birth-table">
      <thead>
        <tr>
          <th>ì°¨íŠ¸ë²ˆí˜¸</th>
          <th>ì„±ëª…</th>
          <th>ì „í™”ë²ˆí˜¸</th>
          <th>ë§Œë‚˜ì´</th>
          <th>ìƒë…„ì›”ì¼</th>
        </tr>
      </thead>
      <tbody>
        <!-- JS -->
      </tbody>
    </table>
  </section>
</div>

<script>
  // ê¸°ì¤€ì¼: ê¸°ë³¸ê°’ ì˜¤ëŠ˜
  const refDateInput = document.getElementById("ref-date");
  (function initRefDate() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    refDateInput.value = `${yyyy}-${mm}-${dd}`;
  })();

  const fileInput = document.getElementById("file-main");
  const runBtn = document.getElementById("btn-run");
  const clearBtn = document.getElementById("btn-clear");
  const birthMonthSelect = document.getElementById("birth-month");
  const statusTextEl = document.getElementById("status-text");
  const tbodyBirth = document.querySelector("#birth-table tbody");

  let baseRows = [];
  // chartNum / name / phone / age / birthDate / birthMonth
  let processedRecords = [];

  function updateStatus(msg, isError = false) {
    statusTextEl.textContent = msg;
    statusTextEl.style.color = isError ? "#fca5a5" : "var(--muted)";
  }

  async function readExcelFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const firstSheet = workbook.SheetNames[0];
          const sheet = workbook.Sheets[firstSheet];
          const json = XLSX.utils.sheet_to_json(sheet, { defval: null });
          resolve(json);
        } catch (err) {
          reject(err);
        }
      };
      reader.onerror = err => reject(err);
      reader.readAsArrayBuffer(file);
    });
  }

  function formatDate(date) {
    if (!date) return "";
    const yyyy = date.getFullYear();
    const mm = String(date.getMonth() + 1).padStart(2, "0");
    const dd = String(date.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  // ì£¼ë¯¼ë²ˆí˜¸ â†’ (ìƒë…„ì›”ì¼, ë§Œë‚˜ì´, ìƒì›”)
  function parseBirthAndAge(rrn, refDate) {
    if (!rrn) return { age: null, birthDate: null, birthMonth: null };
    const s = String(rrn).replace(/[^0-9]/g, "");
    if (s.length < 7) return { age: null, birthDate: null, birthMonth: null };

    const birth6 = s.slice(0, 6);
    const code = s[6];

    let century;
    if (["1","2","5","6"].includes(code)) century = 1900;
    else if (["3","4","7","8"].includes(code)) century = 2000;
    else return { age: null, birthDate: null, birthMonth: null };

    const yy = parseInt(birth6.slice(0, 2), 10);
    const mm = parseInt(birth6.slice(2, 4), 10);
    const dd = parseInt(birth6.slice(4, 6), 10);
    if (!yy || !mm || !dd) return { age: null, birthDate: null, birthMonth: null };

    const year = century + yy;
    const birthDate = new Date(year, mm - 1, dd);
    if (isNaN(birthDate.getTime())) return { age: null, birthDate: null, birthMonth: null };

    let age = refDate.getFullYear() - year;
    const refMonth = refDate.getMonth();
    const refDay = refDate.getDate();
    if (refMonth < (mm - 1) || (refMonth === (mm - 1) && refDay < dd)) age--;

    if (age < 0 || age > 120 || isNaN(age)) age = null;

    return { age, birthDate, birthMonth: mm };
  }

  // í—¤ë” ìë™ ì¸ì‹
  function detectColumnKeys(rows) {
    const first = rows[0] || {};
    const keys = Object.keys(first);
    const trim = (s) => s.replace(/\s/g, "");

    let colChart = null;
    let colName  = null;
    let colPhone = null;
    let colRRN   = null;

    keys.forEach(k => {
      const nk = trim(String(k));
      if (!colChart && /ì°¨íŠ¸|í™˜ìë²ˆí˜¸|ì°¨íŠ¸ë²ˆí˜¸/i.test(nk)) colChart = k;
      if (!colName  && /ì„±ëª…|ì´ë¦„|í™˜ìëª…/i.test(nk))       colName  = k;
      if (!colPhone && /íœ´ëŒ€|ì „í™”/i.test(nk))              colPhone = k;
      if (!colRRN   && /ì£¼ë¯¼/i.test(nk))                   colRRN   = k;
    });

    return { colChart, colName, colPhone, colRRN };
  }

  // ë§Œ18ì„¸ ì´ˆê³¼ + nì›” ìƒì¼ì ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
  function renderBirthdayList(monthStr, adultTotal) {
    tbodyBirth.innerHTML = "";
    if (!processedRecords.length) {
      updateStatus("ë¨¼ì € ì—‘ì…€ì„ ë¶„ì„í•œ ë’¤ ë¦¬ìŠ¤íŠ¸ì—…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", true);
      return 0;
    }

    const targetMonth = parseInt(monthStr, 10); // 1~12

    // ğŸ”‘ í•µì‹¬ í•„í„°: ì„ íƒí•œ ìƒì›” + ë§Œ 18ì„¸ ì´ˆê³¼(19ì„¸ ì´ìƒ)
    const filtered = processedRecords.filter(
      r => r.birthMonth === targetMonth && r.age != null && r.age > 18
    );

    // ì°¨íŠ¸ë²ˆí˜¸ ê¸°ì¤€ ì •ë ¬
    filtered.sort((a, b) => {
      const na = Number(String(a.chartNum).replace(/[^0-9]/g,"")) || 0;
      const nb = Number(String(b.chartNum).replace(/[^0-9]/g,"")) || 0;
      return na - nb;
    });

    filtered.forEach(r => {
      const tr = document.createElement("tr");

      const tdChart = document.createElement("td");
      tdChart.textContent = r.chartNum ?? "";
      tr.appendChild(tdChart);

      const tdName = document.createElement("td");
      tdName.textContent = r.name ?? "";
      tr.appendChild(tdName);

      const tdPhone = document.createElement("td");
      tdPhone.textContent = r.phone ?? "";
      tr.appendChild(tdPhone);

      const tdAge = document.createElement("td");
      tdAge.textContent = r.age != null ? r.age + "ì„¸" : "";
      tr.appendChild(tdAge);

      const tdBirth = document.createElement("td");
      tdBirth.textContent = r.birthDate ? formatDate(r.birthDate) : "";
      tr.appendChild(tdBirth);

      tbodyBirth.appendChild(tr);
    });

    updateStatus(
      `ì—‘ì…€ ë¶„ì„ ì™„ë£Œ: ìœ íš¨í•œ ìƒë…„ì›”ì¼ì´ ìˆëŠ” í™˜ì ${processedRecords.length}ëª… (ê·¸ ì¤‘ ì„±ì¸ ${adultTotal}ëª…)\n` +
      `${targetMonth}ì›” ìƒì¼ì ì¤‘ ì„±ì¸(ë§Œ 18ì„¸ ì´ˆê³¼)ì€ ${filtered.length}ëª…ì…ë‹ˆë‹¤.`
    );
    return filtered.length;
  }

  async function handleRun() {
    try {
      const file = fileInput.files[0];
      if (!file) {
        updateStatus("ì—‘ì…€ íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.", true);
        return;
      }
      if (!refDateInput.value) {
        updateStatus("ê¸°ì¤€ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.", true);
        return;
      }

      runBtn.disabled = true;
      updateStatus("ì—‘ì…€ì„ ì½ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦");

      const rows = await readExcelFile(file);
      baseRows = rows;
      processedRecords = [];
      tbodyBirth.innerHTML = "";

      if (!rows.length) {
        updateStatus("ì‹œíŠ¸ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", true);
        runBtn.disabled = false;
        return;
      }

      const refDateParts = refDateInput.value.split("-");
      const refDate = new Date(
        Number(refDateParts[0]),
        Number(refDateParts[1]) - 1,
        Number(refDateParts[2])
      );

      const { colChart, colName, colPhone, colRRN } = detectColumnKeys(rows);

      if (!colChart || !colName || !colRRN) {
        updateStatus(
`í—¤ë”ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì°¨íŠ¸/ì´ë¦„/ì£¼ë¯¼ ê´€ë ¨ ì—´ ì´ë¦„ì„ í™•ì¸í•´ ì£¼ì„¸ìš”)
ì°¾ì€ ì—´ â†’ ì°¨íŠ¸:${colChart || "-"}, ì´ë¦„:${colName || "-"}, ì£¼ë¯¼:${colRRN || "-"}, ì „í™”:${colPhone || "-"}`,
          true
        );
        runBtn.disabled = false;
        return;
      }

      let total = 0, withRRN = 0, valid = 0;

      rows.forEach(row => {
        total++;
        const chartNum = row[colChart];
        const name = row[colName];
        const phone = colPhone ? row[colPhone] : "";
        const rrn = row[colRRN];

        if (!rrn) return;
        withRRN++;

        const { age, birthDate, birthMonth } = parseBirthAndAge(rrn, refDate);
        if (age == null || !birthDate || !birthMonth) return;

        valid++;
        processedRecords.push({
          chartNum,
          name,
          phone: phone || "",
          age,
          birthDate,
          birthMonth
        });
      });

      const adultTotal = processedRecords.filter(r => r.age != null && r.age > 18).length;

      // í˜„ì¬ ì„ íƒëœ ì›” ê¸°ì¤€ìœ¼ë¡œ ë°”ë¡œ ë Œë”ë§
      renderBirthdayList(birthMonthSelect.value, adultTotal);

      runBtn.disabled = false;

    } catch (err) {
      console.error(err);
      updateStatus("ì—‘ì…€ íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹/í—¤ë”ëª…ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.", true);
      runBtn.disabled = false;
    }
  }

  function handleClear() {
    fileInput.value = "";
    tbodyBirth.innerHTML = "";
    baseRows = [];
    processedRecords = [];
    updateStatus("ì´ˆê¸°í™” ì™„ë£Œ. ì—‘ì…€ì„ ë‹¤ì‹œ ì„ íƒí•œ ë’¤ ë¦¬ìŠ¤íŠ¸ì—… í•´ì£¼ì„¸ìš”.");
  }

  runBtn.addEventListener("click", handleRun);
  clearBtn.addEventListener("click", handleClear);
</script>
</body>
</html>